// load noun words
var nounWordList = "time,year,people,way,day,man,thing,woman,life,child,world,school,state,family,student,group,country,problem,hand,part,place,case,week,company,system,program,question,work,government,number,night,Mr,point,home,water,room,mother,area,money,story,fact,month,lot,right,study,book,eye,job,word,business,issue,side,kind,head,house,service,friend,father,power,hour,game,line,end,member,law,car,city,community,name,president,team,minute,idea,kid,body,information,back,parent,face,others,level,office,door,health,person,art,war,history,party,result,change,morning,reason,research,girl,guy,food,moment,air,teacher,force,education,foot,boy,age,policy,process,music,market,sense,nation,plan,college,interest,death,experience,effect,use,class,control,care,field,development,role,effort,rate,heart,drug,show,leader,light,voice,wife,police,mind,price,report,decision,son,view,relationship,town,road,arm,difference,value,building,action,model,season,society,tax,director,position,player,record,paper,space,ground,form,event,official,matter,center,couple,site,project,activity,star,table,need,court,American,oil,situation,cost,industry,figure,street,image,phone,data,picture,practice,piece,land,product,doctor,wall,patient,worker,news,test,movie,north,love,support,technology,step,baby,computer,type,attention,film,Republican,tree,source,organization,hair,look,century,evidence,window,culture,chance,brother,energy,period,course,summer,plant,opportunity,term,letter,condition,choice,rule,daughter,administration,south,husband,Congress,floor,campaign,material,population,call,economy,hospital,church,risk,fire,future,defense,security,bank,west,sport,board,subject,officer,rest,behavior,performance,top,goal,second,bed,order,author,blood,agency,nature,color,store,sound,movement,page,race,concern,series,language,response,animal,factor,decade,article,east,artist,scene,stock,career,treatment,approach,size,dog,fund,media,sign,thought,list,individual,quality,pressure,answer,resource,meeting,disease,success,cup,amount,ability,staff,character,growth,loss,degree,attack,region,television,box,TV,training,trade,deal,election,feeling,standard,bill,message,analysis,benefit,sex,lawyer,section,glass,skill,sister,professor,operation,crime,stage,authority,design,sort,one,knowledge,gun,station,strategy,truth,song,example,environment,leg,public,executive,set,rock,note,manager,help,network,science,memory,card,seat,cell,trial,expert,spring,firm,Democrat,radio,management,ball,talk,theory,impact,statement,charge,direction,weapon,employee,peace,base,pain,play,measure,interview,chair,fish,camera,structure,politics,bit,weight,candidate,production,trip,evening,conference,unit,style,adult,range,past,edge,writer,trouble,challenge,fear,shoulder,institution,sea,dream,bar,property,stuff,detail,method,magazine,hotel,soldier,cause,bag,heat,fall,marriage,surface,purpose,pattern,skin,agent,owner,machine,gas,generation,cancer,item,reality,coach,Mrs,yard,violence,investment,discussion,finger,garden,collection,task,partner,kitchen,consumer,shot,budget,painting,scientist,agreement,capital,mouth,victim,newspaper,threat,responsibility,attorney,score,account,break,audience,dinner,vote,debate,citizen,majority,wind,mission,customer,speech,option,participant,forest,video,Senate,reform,access,restaurant,judge,relation,bird,opinion,credit,corner,version,safety,neighborhood,act,troop,income,species,track,hope,sky,freedom,plane,object,attitude,labor,concept,client,conversation,variety,turn,investigation,researcher,press,conflict,spirit,argument,camp,brain,feature,afternoon,weekend,possibility,insurance,department,battle,beginning,date,crisis,fan,hole,element,vision,status,ship,solution,stone,scale,university,driver,attempt,park,spot,lack,ice,boat,sun,distance,wood,truck,return,mountain,survey,tradition,winter,village,sales,communication,run,screen,resident,gold,club,farm,increase,middle,presence,district,shape,reader,Ms,contract,crowd,apartment,strength,band,horse,target,prison,guard,demand,reporter,text,share,tool,vehicle,flight,facility,understanding,advantage,leadership,pound,basis,guest,sample,block,protection,while,identity,title,lesson,faith,river,living,technique,path,ear,shop,folk,principle,border,competition,claim,equipment,critic,aspect,failure,Christmas,comment,affair,procedure,chairman,baseball,egg,belief,murder,gift,religion,review,editor,coffee,document,speed,influence,youth,wave,move,quarter,background,reaction,suit,perspective,construction,intelligence,connection,shoe,grade,context,committee,mistake,focus,smile,location,clothes,neighbor,drive,function,bone,average,wine,voter,mean,learning,bus,hell,category,victory,key,visit,Internet,medicine,tour,photo,finding,classroom,contact,justice,pair,exercise,knee,flower,tape,supply,cut,will,actor,birth,search,democracy,circle,device,progress,front,bottom,island,exchange,studio,lady,colleague,application,neck,damage,plastic,plate,writing,start,expression,football,chicken,army,abuse,theater,map,session,danger,literature,rain,desire,assessment,injury,respect,fuel,leaf,instruction,fight,pool,lead,engine,salt,importance,metal,fat,ticket,software,lip,reading,lunch,farmer,sugar,planet,enemy,athlete,soul,panel,meaning,mom,instrument,weather,commitment,pocket,temperature,surprise,poll,proposal,consequence,half,breath,sight,cover,balance,minority,works,teaching,aid,advice,photograph,trail,novel,code,jury,breast,human,theme,storm,union,desk,thanks,fruit,conclusion,shadow,analyst,dance,limit,regulation,being,ring,revenue,county,appearance,package,difficulty,bridge,train,e-mail,thinking,trend,visitor,loan,investor,profit,crew,accident,male,meal,hearing,traffic,muscle,notion,earth,chest,cash,museum,beauty,emergency,stress,content,root,nose,bottle,setting,dress,file,outcome,ad,duty,sheet,extent,component,contrast,zone,airport,chief,shirt,pilot,cat,contribution,capacity,estate,guide,circumstance,snow,politician,percentage,meat,soil,surgery,basketball,golf,chain,address,branch,combination,governor,relief,user,dad,manner,silence,rating,motion,gender,fee,landscape,bowl,frame,host,hall,ocean,row,producer,regime,division,appeal,mirror,tooth,length,topic,variable,telephone,perception,confidence,bedroom,secret,debt,tank,nurse,coverage,opposition,bond,pleasure,master,era,requirement,check,stand,fun,expectation,wing,struggle,judgment,beer,English,reference,tear,doubt,minister,hero,cloud,winner,volume,travel,seed,fashion,pepper,intervention,copy,tip,welfare,vegetable,dish,beach,improvement,opening,route,league,core,rise,tie,holiday,resolution,household,abortion,witness,sector,representative,black,incident,flow,faculty,waste,mass,experiment,bomb,tone,engineer,wheel,female,promise,cable,AIDS,Jew,cream,secretary,gate,hill,noise,grass,hat,legislation,achievement,fishing,drink,talent,taste,characteristic,milk,sentence,height,physician,sleep,ride,explanation,campus,potential,immigrant,alternative,interaction,column,personality,signal,curriculum,honor,passenger,assistance,association,lab,offer,criticism,asset,depression,journalist,prayer,scholar,warning,climate,cheese,observation,childhood,payment,sir,cigarette,definition,priority,bread,creation,graduate,request,emotion,universe,gap,prosecutor,mark,green,airline,library,agenda,factory,selection,roof,expense,initiative,diet,funding,therapy,schedule,housing,post,dark,steel,chip,self,bike,tea,comparison,settlement,layer,planning,description,wedding,portion,territory,opponent,link,lake,tension,display,alcohol,saving,gain,desert,error,release,cop,walk,sand,hit,print,passage,transition,existence,album,participation,atmosphere,cycle,whole,resistance,discovery,exposure,stream,sale,trust,pot,coalition,tale,knife,phase,present,joke,coat,symptom,manufacturer,philosophy,potato,foundation,pass,negotiation,good,occasion,dust,investigator,jacket,reduction,shift,suicide,touch,substance,discipline,iron,passion,volunteer,gene,enforcement,sauce,independence,marketing,priest,advance,employer,shock,illness,cap,habit,juice,involvement,Indian,disaster,parking,prospect,boss,complaint,championship,mystery,poverty,entry,spending,king,symbol,maker,mood,emphasis,boot,entertainment,bean,evaluation,creature,commander,arrangement,total,anger,peak,disorder,missile,wire,round,distribution,transportation,twin,command,commission,interpretation,breakfast,stop,engineering,luck,clinic,veteran,tablespoon,tourist,tomato,exception,butter,deficit,bathroom,objective,ally,journey,reputation,mixture,tower,smoke,dimension,toy,prisoner,peer,designer,personnel,educator,relative,immigration,belt,teaspoon,birthday,implication,coast,supporter,silver,teenager,recognition,retirement,flag,recovery,watch,gentleman,corn,moon,throat,salary,observer,publication,crop,strike,phenomenon,anxiety,convention,exhibition,viewer,pan,consultant,administrator,mayor,consideration,CEO,estimate,buck,poem,grandmother,enterprise,testing,stomach,suggestion,mail,recipe,preparation,concert,intention,channel,tube,drawing,protein,absence,roll,jail,diversity,pace,employment,speaker,impression,essay,respondent,cake,historian,specialist,origin,approval,mine,drop,count,depth,wealth,disability,shell,professional,pack,onion,deputy,brand,award,criteria,dealer,utility,highway,routine,wage,phrase,ingredient,stake,fiber,activist,terrorism,refugee,hip,corporation,assumption,gear,barrier,provision,killer,gang,chemical,label,teen,index,vacation,advocate,draft,heaven,drama,satellite,wonder,clock,chocolate,ceiling,advertising,button,bell,rank,darkness,clothing,fence,portrait,paint,survival,lawsuit,testimony,bunch,beat,burden,chamber,furniture,cooperation,string,ceremony,cheek,profile,mechanism,penalty,match,resort,destruction,bear,tissue,pant,stranger,infection,cabinet,apple,virus,dispute,fortune,assistant,statistics,shopping,cousin,white,port,electricity,adviser,pay,spokesman,incentive,slave,terror,expansion,elite,dirt,rice,bullet,Bible,chart,decline,conservative,stick,concentration,champion,scenario,telescope,reflection,revolution,strip,tournament,fiction,lifetime,recommendation,senator,hunting,salad,boundary,satisfaction,journal,bench,lover,awareness,general,deck,pole,mode,dialogue,founder,pride,aircraft,delivery,platform,finance,joy,worth,singer,shooting,offense,counter,DNA,smell,transfer,protest,crash,craft,treaty,terrorist,insight,lie,episode,fault,mix,assault,stair,adventure,proof,headquarters,violation,tongue,license,hold,shelter,controversy,entrance,favorite,tragedy,net,funeral,profession,establishment,imagination,mask,presentation,introduction,representation,deer,partnership,pollution,emission,fate,earnings,oven,distinction,segment,poet,variation,comfort,honey,correspondent,musician,significance,load,vessel,storage,leather,evolution,tribe,shelf,can,grandfather,lawn,buyer,dining,wisdom,council,instance,garlic,capability,poetry,celebrity,stability,fantasy,plot,framework,gesture,psychology,counselor,chapter,fellow,divorce,pipe,math,shade,tail,obligation,angle,palm,custom,economist,soup,celebration,composition,pile,carbon,scheme,crack,frequency,tobacco,survivor,psychologist,galaxy,ski,limitation,appointment,preference,meter,explosion,arrest,fighter,admission,hunter,friendship,aide,infant,porch,tendency,uniform,formation,scholarship,reservation,efficiency,mall,scandal,PC,heel,privacy,fabric,contest,proportion,guideline,rifle,maintenance,conviction,trick,tent,examination,publisher,French,myth,cow,standing,tennis,nerve,barrel,bombing,membership,ratio,menu,purchase,lifestyle,humor,glove,suspect,narrative,photographer,helicopter,Catholic,provider,delay,stroke,scope,punishment,handful,horizon,girlfriend,cholesterol,adjustment,taxpayer,principal,motivation,assignment,restriction,Palestinian,laboratory,workshop,auto,cotton,motor,flavor,sequence,demonstration,jet,consumption,blade,medication,cabin,edition,valley,pitch,pine,manufacturing,Christian,complex,chef,discrimination,German,boom,heritage,God,shit,lemon,economics,nut,legacy,extension,fly,battery,arrival,orientation,inflation,flame,cluster,wound,shower,operating,flesh,garage,operator,instructor,comedy,mortgage,sanction,habitat,grain,consciousness,measurement,province,ethics,nomination,permission,actress,summit,acid,odds,frustration,medium,grant,shore,lung,discourse,basket,fighting,competitor,powder,ghost,cookie,carrier,cooking,swing,orange,pet,miracle,rhythm,killing,sin,charity,script,tactic,identification,transformation,headline,venture,invasion,military,piano,grocery,intensity,blanket,margin,quarterback,mouse,rope,prescription,brick,patch,consensus,horror,recording,painter,pie,sake,gaze,courage,pregnancy,clue,win,confusion,slice,occupation,coal,criminal,formula,uncle,square,captain,gallery,soccer,defendant,tunnel,fitness,lap,grave,toe,container,virtue,architect,makeup,inquiry,rose,indication,rail,anniversary,couch,alliance,hypothesis,boyfriend,mess,legend,adolescent,norm,remark,reward,organ,laughter,northwest,counseling,receiver,ritual,insect,salmon,favor,trading,combat,stem,surgeon,physics,rape,counsel,brush,jeans,log,pill,sculpture,compound,flour,slope,presidency,serving,bishop,drinking,cry,acceptance,collapse,pump,candy,evil,final,medal,export,midnight,curve,integrity,logic,essence,closet,interior,corridor,pitcher,snake,cross,weakness,pig,cold,T-shirt,unemployment,civilization,pop,correlation,humanity,developer,excitement,beef,Islam,stretch,architecture,elbow,Muslim,allegation,airplane,duck,dose,lecture,van,bay,suburb,sandwich,trunk,rumor,implementation,cloth,effectiveness,lens,reach,inspector,fraud,companion,nail,array,rat,hallway,cave,southwest,monster,obstacle,encounter,herb,integration,crystal,recession,wish,motive,flood,pen,ownership,nightmare,notice,inspection,supervisor,arena,laugh,diagnosis,possession,basement,prosecution,announcement,warrior,prediction,bacteria,questionnaire,mud,infrastructure,privilege,temple,broadcast,wrist,curtain,monitor,pond,domain,guilt,cattle,walking,playoff,skirt,database,aim,limb,ideology,harm,railroad,radiation,horn,innovation,strain,guitar,replacement,dancer,amendment,pad,transmission,grace,colony,adoption,slide,civilian,towel,particle,glance,prize,landing,conduct,blue,bat,alarm,festival,grip,freshman,sweat,European,separation,southeast,ballot,rhetoric,vitamin,enthusiasm,wilderness,mandate,pause,excuse,uncertainty,chaos,canvas,lobby,format,trait,currency,turkey,reserve,beam,astronomer,corruption,contractor,doctrine,thumb,unity,compromise,rush,complexity,fork,disk,suspicion,lock,finish,residence,shame,sidewalk,Olympics,signature,rebel,spouse,fluid,pension,sodium,blow,promotion,forehead,hook,detective,traveler,compensation,exit,attraction,pickup,needle,belly,portfolio,shuttle,timing,engagement,ankle,transaction,counterpart,rider,doll,noon,exhibit,carbohydrate,liberty,poster,theology,oxygen,magic,sum,businessman,determination,donor,pastor,jazz,opera,Japanese,bite,acquisition,pit,wildlife,giant,primary,equity,doorway,departure,elevator,guidance,happiness,statue,pursuit,repair,gym,clerk,Israeli,envelope,reporting,destination,fist,exploration,bath,rescue,indicator,sunlight,feedback,spectrum,laser,starting,expertise,tune,eating,hint,parade,realm,ban,therapist,pizza,recipient,accounting,bias,metaphor,candle,handle,worry,entity,suffering,feel,lamp,garbage,servant,addition,inside,reception,chin,necessity,racism,starter,banking,gravity,prevention,Arab,performer,intent,inventory,assembly,silk,magnitude,hostage,collector,popularity,kiss,alien,equation,angel,switch,offering,rage,photography,toilet,Russian,wake,gathering,automobile,dawn,tide,romance,hardware,pillow,kit,cook,spread,continent,circuit,sink,ruling,shortage,trap,fool,deadline,processing,ranch,diamond,credibility,import,sentiment,cart,elder,pro,inspiration,quantity,trailer,mate,genius,monument,bid,quest,sacrifice,invitation,accuracy,juror,broker,treasure,loyalty,gasoline,output,nominee,diabetes,jaw,grief,rocket,inmate,dynamics,bow,senior,dignity,carpet,bubble,buddy,barn,sword,flash,glory,drum,queen,dilemma,input,northeast,liability,hay,stadium,defeat,withdrawal,refrigerator,nest,lane,ancestor,steam,accent,escape,cage,shrimp,homeland,rack,costume,wolf,courtroom,statute,cartoon,productivity,seal,bug,aunt,agriculture,bankruptcy,vaccine,bonus,collaboration,orbit,patience,voting,patrol,willingness,revelation,rent,jewelry,trace,wagon,reliability,ass,bush,clip,thigh,bull,drawer,sheep,coordinator,runner,empire,cab,exam,documentary,biology,web,conspiracy,catch,casualty,republic,execution,whale,instinct,teammate,aluminum,ministry,verdict,skull,self-esteem,ease,bee,practitioner,loop,puzzle,mushroom,subsidy,mathematics,mechanic,jar,earthquake,pork,creativity,dessert,sympathy,fisherman,isolation,sock,jump,entrepreneur,syndrome,bureau,workplace,ambition,touchdown,breeze,Christianity,translation,gut,booth,helmet,waist,lion,accomplishment,panic,cast,cliff,cord,cocaine,illusion,appreciation,commissioner,flexibility,casino,tumor,pulse,equivalent,donation,diary,sibling,irony,spoon,midst,alley,soap,rival,pin,hockey,supplier,momentum,purse,liquid,icon,elephant,legislature,associate,franchise,bicycle,fever,filter,rabbit,coin,organism,sensation,stay,minimum,conservation,backyard,charter,stove,consent,reminder,placement,dough,grandchild,dam,outfit,columnist,workout,patent,quote,trash,hormone,texture,pencil,frontier,spray,bet,custody,banker,beast,oak,notebook,attendance,speculation,shark,mill,installation,tag,swimming,fleet,catalog,outsider,stance,sensitivity,debut,confrontation,ideal,constitution,trainer,Thanksgiving,scent,stack,eyebrow,sack,tray,pioneer,textbook,dot,wheat,kingdom,aisle,protocol,marketplace,terrain,pasta,genre,merit,planner,chunk,discount,ladder,jungle,migration,breathing,hurricane,retailer,coup,ambassador,density,curiosity,aggression,stimulus,journalism,robot,feather,sphere,publicity,major,well-being,validity,ecosystem,collar,weed,compliance,streak,builder,glimpse,premise,specialty,artifact,monkey,mentor,listener,lightning,sleeve,disappointment,rib,debris,rod,liberal,ash,parish,slavery,commodity,cure,mineral,hunger,equality,cemetery,harassment,fame,likelihood,carrot,toll,rim,wheelchair,squad,processor,sponsor,grin,chill,refuge,legislator,rally,programming,outlet,vendor,peanut,intellectual,conception,auction,steak,triumph,shareholder,conscience,calculation,interval,jurisdiction,constraint,expedition,similarity,butt,lid,bulk,mortality,conversion,patron,liver,harmony,tolerance,instant,goat,blessing,banana,running,palace,peasant,grandparent,lawmaker,supermarket,cruise,plain,calendar,widow,deposit,beard,brake,screening,impulse,fur,predator,forum,dancing,removal,autonomy,thread,landmark,offender,fraction,tourism,threshold,suite,regulator,straw,globe,objection,chemistry,blast,denial,rental,fragment,warmth,undergraduate,headache,policeman,yield,projection,mention,graduation,mansion,regard,grape,cottage,driveway,charm,sexuality,clay,balloon,invention,ego,fare,homework,disc,sofa,guarantee,availability,radar,leave,permit,sweater,rehabilitation,retreat,molecule,youngster,premium,accountability,fatigue,marker,bucket,confession,marble,twist,defender,transport,surveillance,technician,arrow,trauma,ribbon,meantime,harvest,spy,slot,riot,nutrient,citizenship,sovereignty,ridge,lighting,contributor,transit,seminar,electronics,shorts,accusation,cue,bride,biography,hazard,tile,foreigner,launch,convenience,delight,timber,plea,bulb,devil,bolt,cargo,spine,seller,dock,fog,diplomat,summary,missionary,epidemic,warehouse,butterfly,bronze,praise,vacuum,stereotype,sensor,laundry,manual,pistol,plaintiff,apology";

var nounWordSet = new Set();
for (let str of nounWordList.split(/,/)) {
    nounWordSet.add(str.toLowerCase());
}
for (let i = 0;i < 1000000;i ++) {
    nounWordSet.add("" + i);
}


function SplunkMetaData() {
    // this.indexMap = new Map();
    this.indexList = [];
    this.sourceTypeList = [];
    this.fieldsList = [];
}

/*
SplunkMetaData.prototype.addIndex = function(indexName) {
    if (this.indexMap.has(indexName) == false) {
        this.indexMap.set(indexName , new Map());
    }
};

SplunkMetaData.prototype.addSourceType = function(indexName, sourceTypeName) {
    if (this.indexMap.has(indexName) == false) {
        this.indexMap.set(indexName , new Map());
    }
    if (this.indexMap.get(indexName).has(sourceTypeName) == false) {
        this.indexMap.get(indexName).set(sourceTypeName, new Set());
    }
};

SplunkMetaData.prototype.addFieldName = function(indexName, sourceTypeName, fieldName) {
    if (this.indexMap.has(indexName) == false) {
        this.indexMap.set(indexName , new Map());
    }
    if (this.indexMap.get(indexName).has(sourceTypeName) == false) {
        this.indexMap.get(indexName).set(sourceTypeName, new Set());
    }
    this.indexMap.get(indexName).get(sourceTypeName).add(fieldName);
};*/


SplunkMetaData.prototype.addIndex = function(indexName) {
    this.indexList.push(indexName);
};

SplunkMetaData.prototype.addSourceType = function(sourceType) {
    this.sourceTypeList.push(sourceType);
};

SplunkMetaData.prototype.addField = function(fieldName) {
    this.fieldsList.push(fieldName);
};


function lcs(string1 , string2) {

    if (string1.length == 0 || string2.length == 0) {
        return 0;
    }

    let dp = new Array(string1.length);
    for (let i = 0;i < string1.length; i++) {
        dp[i] = new Array(string2.length);
        for (let j = 0;j < string2.length;j ++) {
            dp[i][j] = 0;
        }
    }

    for (let i = 0;i < string1.length;i ++) {
        if (string1[i] == string2[0]) {
            dp[i][0] = 1;
        } else {
            if (i > 0) {
                dp[i][0] = dp[i - 1][0];
            }
        }
    }
    for (let i = 0;i < string2.length;i ++) {
        if (string1[0] == string2[i]) {
            dp[0][i] = 1;
        } else {
            if (i > 0) {
                dp[0][i] = dp[0][i - 1];
            }
        }
    }
    for (let i = 1;i < string1.length;i ++) {
        for (let j = 1;j < string2.length;j ++) {
            if (string1[i] == string2[j]) {
                dp[i][j] = dp[i - 1][j - 1] + 1;
            } else {
                dp[i][j] = Math.max(dp[i - 1][j] , dp[i][j - 1]);
            }
        }
    }
    return dp[string1.length - 1][string2.length - 1];

}

function editDist(word1 , word2) {

    if (word1.length == 0 || word2.length == 0) {
        return word1.length + word2.length;
    } else {
        let dp = new Array(word1.length);
        for (let i = 0;i < word1.length; i++) {
            dp[i] = new Array(word2.length);
            for (let j = 0;j < word2.length;j ++) {
                dp[i][j] = 0;
            }
        }

        for (let i = 0;i < word1.length;i ++) {
            if (word1[i] == word2[0]) {
                dp[i][0] = i;
            } else {
                if (i == 0) {
                    dp[i][0] = 1;
                } else {
                    dp[i][0] = dp[i - 1][0] + 1;
                }
            }
        }

        for (let i = 0;i < word2.length;i ++) {
            if (word1[0] == word2[i]) {
                dp[0][i] = i;
            } else {
                if (i == 0) {
                    dp[0][i] = 1;
                } else {
                    dp[0][i] = dp[0][i - 1] + 1;
                }
            }
        }

        for (let i = 1;i < word1.length;i ++) {
            for (let j = 1;j < word2.length;j ++) {
                if (word1[i] == word2[j]) {
                    dp[i][j] = dp[i - 1][j - 1];
                } else {
                    dp[i][j] = Math.min(Math.min(dp[i - 1][j], dp[i][j - 1]), dp[i - 1][j - 1]) + 1;
                }
             }
        }

        return dp[word1.length - 1][word2.length - 1];

    }

}


function wordMatch(w0, w1, alg='soundex'){
    if (alg === 'soundex'){
        return soundex(w0) === soundex(w1);
    } else if (alg === 'double-metaphone'){
        let dm_w0 = double_metaphone(w0);
        let dm_w1 = double_metaphone(w1);
        // alert(dm_w0.primary + ' , ' + dm_w0.secondary + ' | ' + dm_w1.primary + ' , ' + dm_w1.secondary)
        if (dm_w0.primary){
            if (dm_w0.primary === dm_w1.primary || dm_w0.primary === dm_w1.secondary){
                return true;
            }
        }
        else
        {
            return false;
        }
        if (dm_w0.secondary){
            if (dm_w0.secondary === dm_w1.primary || dm_w0.secondary === dm_w1.primary){
                return true;
            }
        }
        else
        {
            return false;
        }
        return false;
    }
    else{
        return false;
    }
}

function wordListMatch(word, wordList, alg = "soundex") {
    for (let checkWord of wordList) {
        if (wordMatch(word, checkWord, alg)) {
            return true;
        }
    }
    return false;
}

function getWordValue(word, alg = 'soundex') {
    if (alg == 'soundex') {
        return soundex(word);
    } else if (alg == "double-metaphone") {
        return double_metaphone(word);
    } else {
        return word;
    }
}



function Element(dist, word1 , word2) {
    this.dist = dist;
    this.word1 = word1;
    this.word2 = word2;
}

// implement recommend function
function recommend(value, valueType, valueList) {

    let strs = value.split(/\s+/);
    let elements = [];
    let ans = [];
    let visSet = new Set();

    for (let i = 1;i < strs.length;i ++) {
        let current = strs[i];
        for (let value of valueList) {
            if (wordMatch(current, value, "double-metaphone")) {
                return [];
            }
        }
    }
    for (let i = 1;i < strs.length;i ++) {
        for (let value of valueList) {
            let dist = editDist(strs[i] , value);
            elements.push(new Element(dist, strs[i] , value));
        }
    }
    elements.sort(function(e1 , e2) {
       if (e1.dist < e2.dist) {
           return - 1;
       } else if (e1.dist > e2.dist) {
           return 1;
       } else {
           return 0;
       }
    });

    for (let e of elements) {
        if (!visSet.has(e.word2)) {
            visSet.add(e.word2);
            ans.push(e.word2);
            if (ans.length == 4) {
                break;
            }
        }
    }
    return ans;

};


SplunkMetaData.prototype.getIndexName = function(indexName) {

    let maxDist = - 1;
    let ans = '';
    for (let name of this.indexList) {
        let temp = editDist(name , indexName);
        if (temp < maxDist || maxDist < 0) {
            maxDist = temp;
            ans = name;
        } else if (temp == maxDist) {
            if (name.length < ans.length) {
                ans = name;
            }
        }
    }
    return ans;

};

SplunkMetaData.prototype.getSourceType = function(sourceType) {

    let maxDist = - 1;
    let ans = '';
    for (let name of this.sourceTypeList) {
        let temp = editDist(name, sourceType);
        if (temp < maxDist || maxDist < 0) {
            maxDist = temp;
            ans = name;
        } else if (temp == maxDist) {
            if (name.length < ans.length) {
                ans = name;
            }
        }
    }
    return ans;

};

SplunkMetaData.prototype.getFieldName = function(fieldName) {

    let maxDist = - 1;
    let ans = '';
    for (let name of this.fieldsList) {
        let temp = editDist(name, fieldName);
        if (temp < maxDist || maxDist < 0) {
            maxDist = temp;
            ans = name;
        } else if (temp == maxDist) {
            if (name.length < ans.length) {
                ans = name;
            }
        }
    }
    return ans;

};


let highlight_check_box = document.getElementById('convert_color');
let audio_recorder = document.getElementById('recorder');
let started=false;
let bshow=false;
let workMode = "";
let recognition;
let b_highlight = false;
var SW;

// Move this part to somewhere else later

function get_key_words() {
    urls = {
        "indexes": "http://localhost:8000/en-US/splunkd/__raw/services/data/indexes?output_mode=json&count=-1",
        "sourcetypes": "http://localhost:8000/en-US/splunkd/__raw/services/saved/sourcetypes?output_mode=json&count=-1"
    }
    result = {}
    for (key in urls) {
        $.getJSON({
            url: urls[key],
            success: function(data){
                values = []
                for (idx in data["entry"]) {
                    values.push(data["entry"][idx]["name"])
                }
                result[key] = values;
            },
            async: false
        })
    }
    return result;
}

function get_fields(index, sourcetype, callback) {

    index = index || '_*'
    sourcetype = sourcetype || '*'

    search = 'index=' + index + ' sourcetype=' + sourcetype + '| fieldsummary | fields field'

    data = {
        rf: '*',
        count: '0',
        auto_cancel: '30',
        status_buckets: '300',
        output_mode: 'json',
        'custom.display.page.search.mode': 'smart',
        'custom.dispatch.sample_ratio': '1',
        'custom.search': search,
        'custom.dispatch.earliest_time': '-24h@h',
        'custom.dispatch.latest_time': 'now',
        search: 'search ' + search,
        earliest_time: '-24h@h',
        exec_mode:'oneshot',
        latest_time: 'now',
        ui_dispatch_app: 'search',
        preview: '1',
        adhoc_search_level: 'smart',
        indexedRealtime: '',
        sample_ratio: '1',
        check_risky_command: 'false',
        provenance: 'UI:Search'
    }

    chrome.cookies.getAll({}, function (cookies) {
            cookies.forEach(function(cookie) {
                if (cookie.domain === 'localhost' && cookie.name === 'splunkweb_csrf_token_8000') {
                    splunkweb_csrf_token_8000 = cookie.value;
                    $.ajax({
                        url: 'http://localhost:8000/en-US/splunkd/__raw/servicesNS/admin/search/search/jobs',
                        data: data,
                        dataType: 'json',
                        headers: {'X-Splunk-Form-Key' : splunkweb_csrf_token_8000},
                        type: 'POST',
                        crossDomain: false,
                        success: function(data) {
                            result = []
                            for (i in data['results']) {
                                result.push(data['results'][i]['field']);
                            }
                            callback && callback(result);
                        }
                    });
                }
            });
        }
    );
}


let splunkMetadata;
let splManager;

function asyncLoadFields() {

    while (splunkMetadata.fieldsList.length > 0) {
        splunkMetadata.fieldsList.pop();
    }
    get_fields(splManager.indexName, splManager.sourceType, function(result) {
        alert("get all fields success: " + result.length);
        for (let fieldName of result) {
            splunkMetadata.addField(fieldName);
        }
    });

}

function searchInitialize() {

    let result = get_key_words();
    let indexes_list = result['indexes'];
    let sourcetype_list = result['sourcetypes'];

    splunkMetadata = new SplunkMetaData();
    splManager = new Spl();

    asyncLoadFields();

    for (let indexName of indexes_list) {
        splunkMetadata.addIndex(indexName);
    }
    for (let sourcetype of sourcetype_list) {
        splunkMetadata.addSourceType(sourcetype);
    }

};

/**
 * spl class
 */
function Spl() {
    this.indexName = '_*';
    this.sourceType = '*';

    this.statementFlag = false;

    this.pipeline = [];

    this.fieldsMap = new Map();
}


/**
 * variables related to recommend
 */
var lastRecommendResult = [];
var lastRecommendType = '';
var lastRecommendFlag = 0;

Spl.prototype.setStatementFlag = function(statementFlag) {
    this.statementFlag = statementFlag;
};

Spl.prototype.toUrlString = function() {

    // construct url from indexName, sourceType, pipeline and current fieldsMap
    let splString = '';

    splString += " | index = " + this.indexName;

    splString += " sourcetype = " + this.sourceType;

    for (let fMap of this.pipeline) {
        splString = splString + " | search " + this.getSplString(fMap);
    }

    if (this.fieldsMap.size > 0) {
        splString = splString + " | search " + this.getSplString(this.fieldsMap);
    }

    return splString;

};

Spl.prototype.getSplString = function(fieldsMap) {

    /**
     * get spl string from fieldsMap
     */
    const that = this;
    let ans = "";
    fieldsMap.forEach(function(field) {
        if (ans != "") {
            ans = ans + " ";
        }
        // binary field
        if ((field.fieldType == "or") || (field.fieldType == "and")) {
            let field1 = that.getSplStringForField(field.leftField);
            let field2 = that.getSplStringForField(field.rightField);
            ans += field1 + " " + field.fieldType.toUpperCase() + " " + field2;
        } else {
            ans += that.getSplStringForField(field);
        }
    });

    return ans;

};

Spl.prototype.getSplStringForField = function(field) {
    let ans = "";
    switch (field.fieldType) {
        case "contain":
            ans = field.fieldName + " = *" + field.fieldValue + "*";
            break;
        case "equal":
            ans = field.fieldName + " = " + field.fieldValue;
            break;
        case "greater":
            ans = field.fieldName + " > " + field.fieldValue;
            break;
        case "less":
            ans = field.fieldName + " < " + field.fieldValue;
            break;
        case "search":
            ans = field.fieldValue;
            break;
    }
    return ans;
};

Spl.prototype.extractField = function(statement) {

    /*
        contains
        equals to
        greater than
        less than
        normal
     */
    let fieldTypeList = ["contain", "equal", "greater", "less"];
    let fieldPatterns = [["contains", "contain", "have", "has", "likes", "like"], ["equals", "equal", "is", "was"], ["greater", "larger", "bigger"], ["less", "smaller"]];

    let fieldName = '' , fieldValue = '' , fieldType = '';
    for (let i = 0;i < fieldTypeList.length;i ++) {
        for (let pattern of fieldPatterns[i]) {
            let patternString = this.getStringWithSamePattern(statement, pattern, 'double-metaphone');
            if (statement.match(patternString)) {
                let strs = statement.split(patternString);
                fieldName = this.getValue(strs[0].trim(), 'fieldName');
                fieldValue = this.getValue(strs[1].trim(), 'fieldValue');
                fieldType = fieldTypeList[i];

                alert(fieldName + "-" + fieldValue + "-" + fieldType);

                return new Field(fieldName, fieldValue, fieldType);
            }
        }
    }

    let value = this.getValue(statement, 'fieldValue');

    alert("search_" + value);

    return new Field("search_" + value, value, "search");

};

Spl.prototype.isPrefix = function(prefix, statement, alg = 'soundex') {

    let strs1 = prefix.trim().split(/\s+/);
    let strs2 = statement.trim().split(/\s+/);

    for (let i = 0;i < strs1.length && i < strs2.length;i ++) {
        if (wordMatch(strs1[i], strs2[i], alg) == false) {
            return false;
        }
    }
    return true;

};

Spl.prototype.getStringWithSamePattern = function(string, pattern, algo = 'soundex') {

    let strs = string.trim().split(/\s+/);
    for (let str of strs) {
        if (wordMatch(str, pattern, algo)) {
            return str;
        }
    }
    return pattern;

};

Spl.prototype.getStatementType = function(statement, b_shortcut=false) {

    // first word
    let firstStatement = !b_shortcut ? statement.trim().split(/\s+/)[0] : statement;

    let statementTypeList = !b_shortcut ? ['aloha', 'index', 'type', 'commit', 'rollback', 'where', 'search', 'select'] : ['aloha commit', 'aloha rollback'];
    let maxDist = - 1;
    let ans = "";
    for (let type of statementTypeList) {
        if (this.isPrefix(type, statement, 'double-metaphone')){
            return type;
        }
        let dist = editDist(type, firstStatement);
        if (dist < maxDist || maxDist < 0) {
            maxDist = dist;
            ans = type;
        } else if (dist == maxDist) {
            if (type.length < ans.length) {
                ans = type;
            }
        }
    }
    return ans;

};

Spl.prototype.getValue = function(value, valueType) {

    if (valueType == 'fieldName') {
        let nounArray = nlp(value).nouns().out("array");

        let maxDist = - 1;
        let strs = value.trim().split(/\s+/);
        let ans = "";

        for (let str of strs) {
            // if (nounArray.has(str)) {
            for (let fieldName of splunkMetadata.fieldsList) {
                if (wordMatch(str, fieldName, "double-metaphone")) {
                    return fieldName;
                }

                let dist = editDist(fieldName, str);
                if (dist < maxDist || maxDist < 0) {
                    maxDist = dist;
                    ans = fieldName;
                } else if (dist == maxDist) {
                    if (fieldName.length < ans.length) {
                        ans = fieldName;
                    }
                }
            }
        }

        for (let name of nounArray) {
            for (let fieldName of splunkMetadata.fieldsList) {
                if (wordMatch(name, fieldName, "double-metaphone")) {
                    return fieldName;
                }

                let dist = editDist(fieldName, name);
                if (dist < maxDist || maxDist < 0) {
                    maxDist = dist;
                    ans = fieldName;
                } else if (dist == maxDist) {
                    if (fieldName.length < ans.length) {
                        ans = fieldName;
                    }
                }
            }
        }

        return ans;
    } else if (valueType == 'fieldValue') {
        /**
         * check topic model
         */
        let topicArray = nlp(value).topics().data();
        if (topicArray.length > 0) {
            // choose the first one
            return topicArray[0].normal;
        }

        /**
         * check number
         */
        let numberResult = nlp(value).values().toNumber().out();
        if (numberResult != '') {
            return numberResult;
        }

        /**
         * choose the first noun
         */
        let result = nlp(value).nouns().out("array");
        if (result.length > 0) {
            return result[0];
        }

        /**
         * choose words in nounWordSet
         */
        let strs = value.trim().split(/\s+/);
        for (let word of strs) {
            if (nounWordSet.has(word)) {
                return word;
            }
        }

        /**
         * choose first word
         */
        return value.trim().split(/\s+/)[0];
    } else {
        // use last non-empty string
        let strs = value.trim().split(/\s+/);
        return strs[strs.length - 1];
    }

};

Spl.prototype.addNewStatement = function(statement) {

    let words = statement.trim().split(/\s+/);
    let b_shortcut = false;

    // if (words.length > 1 && wordMatch("aloha", words[0], "double-metaphone")) {
    //     b_shortcut = true;
    //     this.statementFlag = true;
    //     set_aloha_status(true);
    // }
    if (wordMatch("aloha", words[0], "double-metaphone")){
        this.statementFlag = true;
        set_aloha_status(true);

        update_comment(statement, "may i help you");
        voiceComment += ", may i help you";

        return false;
    }

    if (this.statementFlag) {
        set_aloha_status(false);

        // used in index and source type
        let skippedWords = ['could', 'can', 'would', 'please',
            'help', 'me', 'you' , 'should',
            'be', 'might', 'supposed', 'to', 'how', 'would', 'is', 'was', 'this', 'that', 'equal', 'equals'];

        // add a new statement
        let predicted_statement = this.getStatementType(statement, b_shortcut);
        alert("predicted:" + predicted_statement);
        if (predicted_statement === "index") {
            // index
            let array = statement.trim().split(/\s+/);
            if (array.length > 1) {
                let finalIndexName = "";
                for (let i = 1;i < array.length;i ++) {
                    if (skippedWords.includes(array[i])) {
                        continue;
                    }

                    let indexName = splunkMetadata.getIndexName(array[i]);
                    if (wordMatch(indexName, array[i], 'double-metaphone')) {
                        finalIndexName = indexName;
                        break;
                    }
                    if (finalIndexName == "" || (indexName.length < finalIndexName.length)) {
                        finalIndexName = indexName;
                    }
                }
                if (finalIndexName == "") {
                    update_comment(statement, "please give me a legal index name");
                    voiceComment = "please give me a legal index name";
                    return false;
                }
                this.indexName = finalIndexName;

                asyncLoadFields();

                update_comment(statement, "index is " + this.indexName + " now");
                voiceComment += ", index is " + this.indexName + " now";

                // recommend
                let recommendResult = recommend(statement, 'index', splunkMetadata.indexList);
                if (recommendResult.length > 0) {
                    update_comment("index", "you may interested in " + recommendResult.join(", "));
                    voiceComment += ", you may interested in " + recommendResult.join(", ");

                    lastRecommendResult = recommendResult;
                    lastRecommendFlag = 5;
                    lastRecommendType = 'index';
                }
            } else {
                // document.getElementById("show_text").innerHTML = "please say a correct index";

                update_comment(statement, "please give me a legal index name");
                voiceComment = "please give me a legal index name";

                return false;
            }
        } else if (predicted_statement === "type") {
            // source type
            let array = statement.trim().split(/\s+/);
            if (array.length > 1) {
                let finalSourceType = "";
                for (let i = 1;i < array.length;i ++) {
                    if (skippedWords.includes(array[i])) {
                        continue;
                    }

                    let sourceType = splunkMetadata.getSourceType(array[i]);
                    if (wordMatch(sourceType, array[i], "double-metaphone")) {
                        finalSourceType = sourceType;
                        break;
                    }
                    if (finalSourceType == "" || (sourceType.length < finalSourceType.length)) {
                        finalSourceType = sourceType;
                    }
                }
                if (finalSourceType == "") {
                    update_comment(statement, "please give me a legal sourcetype");
                    voiceComment = "please give me a legal source type";
                    return false;
                }
                this.sourceType = finalSourceType;

                asyncLoadFields();

                update_comment(statement, "sourcetype is " + this.sourceType + " now");
                voiceComment = ", source type is " + this.sourceType + " now";

                // recommend
                let recommendResult = recommend(statement, 'sorucetype', splunkMetadata.sourceTypeList);
                if (recommendResult.length > 0) {
                    update_comment("source type", "you may interested in " + recommendResult.join(", "));
                    voiceComment += ", you may interested in " + recommendResult.join(", ");

                    lastRecommendResult = recommendResult;
                    lastRecommendType = 'sourcetype';
                    lastRecommendFlag = 5;
                }
            } else {
                // document.getElementById("show_text").innerHTML = "please say a correct source type";

                update_comment(statement, "please give me a legal sourcetype");
                voiceComment = "please give me a legal source type";

                return false;
            }
        } else if (predicted_statement.includes("commit")) {
            if (this.fieldsMap.size > 0) {
                let newMap = new Map();
                this.fieldsMap.forEach(function (field, fieldName) {
                    newMap.set(fieldName, field);
                });
                this.pipeline.push(newMap);
                this.fieldsMap.clear();

                update_comment(statement, "commit current pipeline");
                voiceComment += ", commit current pipeline";

            }
            return false;
        } else if (predicted_statement.includes("rollback")) {
            if (this.fieldsMap.size > 0) {
                this.fieldsMap.clear();
            } else {
                if (this.pipeline.length > 0) {
                    this.pipeline.pop();
                } else {
                    update_comment(statement, "pipeline is empty");
                    voiceComment = "pipeline is empty now";
                }
            }

            update_comment(statement, "rollback current pipeline");
            voiceComment += ", rollback current pipeline";

        } else if (predicted_statement === 'where') {
            let strs = statement.trim().split(/\s+/);
            if (strs.length <= 1) {

                update_comment(statement, "please give me a legal where statement");
                voiceComment = "please give me a legal where statement";

                return false;
            }
            statement = "";
            for (let i = 1;i < strs.length;i ++) {
                if (i > 1) {
                    statement += " ";
                }
                statement += strs[i];
            }

            if (this.isBetweenStatement(statement)) {

                let betweenString = this.getStringWithSamePattern(statement, "between", "double-metaphone");
                let andString = this.getStringWithSamePattern(statement, "and", "double-metaphone");

                let strs = statement.trim().split(betweenString);
                let temp = strs[1].split(andString);

                let fieldValue1 = this.getValue(temp[0], 'fieldValue');
                let fieldValue2 = this.getValue(temp[1], 'fieldValue');
                let fieldName = this.getValue(strs[0], 'fieldName');

                // all fields are legal
                if (fieldName != '' && fieldValue1 != '' && fieldValue2 != '') {

                    // fieldName > fieldValue1 and fieldName < fieldValue2
                    let newStatement = "where " + fieldName + " greater " + fieldValue1 + " and " + fieldName + " less " + fieldValue2;
                    // alert(newStatement);
                    this.statementFlag = true;
                    set_aloha_status(true);

                    update_comment(statement, newStatement);
                    voiceComment += ", where " + fieldName + " between " + fieldValue1 + " and " + fieldValue2;

                    return this.addNewStatement(newStatement);
                } else {

                    update_comment(statement, "please give me a legal between statement");
                    voiceComment = "please give me a legal between statement";

                    return false;
                }
            } else if (this.isBinaryFieldStatement(statement)) {

                let orString = this.getStringWithSamePattern(statement, "or", "double-metaphone");
                let andString = this.getStringWithSamePattern(statement, "and", "double-metaphone");

                let splitCharacter = "";
                let splitString = "";

                if (statement.includes(orString)) {
                    splitCharacter = "or";
                    splitString = orString;
                } else if (statement.includes(andString)) {
                    splitCharacter = "and";
                    splitString = andString;
                }

                let strs = statement.split(splitString);
                let leftField = this.extractField(strs[0]), rightField = this.extractField(strs[1]);

                if (leftField.fieldName != '' && leftField.fieldValue != '' && rightField.fieldName != '' && rightField.fieldValue != '') {
                    let binaryField = new BinaryField(leftField.fieldName + "_" + splitCharacter + "_" + rightField.fieldName,
                        splitCharacter, leftField, rightField);

                    this.fieldsMap.set(binaryField.fieldName, binaryField);

                    update_comment(statement, splitString + " statement");
                    voiceComment += ", " + splitString + " statement";
                } else {
                    update_comment(statement, "please give me a legal " + splitString + " statement");
                    voiceComment = "please give me a legal " + splitString + " statement";
                    return false;
                }
            } else {
                // single field
                let field = this.extractField(statement);
                if (field.fieldName != '' && field.fieldValue != '') {
                    this.fieldsMap.set(field.fieldName, field);

                    update_comment(statement, field.fieldName + " " + field.fieldValue);
                    voiceComment += ", filter " + field.fieldName;
                } else {

                    update_comment(statement, "please give me a legal filter statement");
                    voiceComment = "please give me a legal filter statement";

                    return false;
                }
            }
        } else if (predicted_statement == 'search') {
            let strs = statement.trim().split(/\s+/);
            statement = '';
            for (let i = 1;i < strs.length;i ++) {
                if (i > 1) {
                    statement = statement + " ";
                }
                statement = statement + strs[i];
            }
            let fieldValue = this.getValue(statement, 'fieldValue');
            if (fieldValue != '') {
                this.fieldsMap.set("search_" + fieldValue, new Field("search_" + fieldValue, fieldValue, "search"));

                update_comment(statement, 'search ' + fieldValue);
                voiceComment += ", search " + fieldValue;
            } else {
                return false;
            }
        } else if (predicted_statement == 'select') {
            if (lastRecommendFlag > 0) {
                let candidates = ['apple' , 'banana' , 'cat' , 'dog'];
                let strs = statement.trim().split(/\s+/);
                if (strs.length > 1) {
                    let choose = '';
                    for (let i = 1; i < strs.length; i++) {
                        let word = strs[i];
                        for (let candidate of candidates) {
                            if (wordMatch(word, candidate, 'double-metaphone')) {
                                choose = candidate;
                                break;
                            }
                        }
                        if (choose != '') {
                            break;
                        }
                    }
                    if (choose != '') {
                        let index = choose.charCodeAt(0) - 97;
                        if (lastRecommendType == 'index') {
                            this.indexName = lastRecommendResult[index];
                        } else if (lastRecommendType == 'sourcetype') {
                            this.sourceType = lastRecommendResult[index];
                        }
                        update_comment(statement, "update " + lastRecommendType + " to " + lastRecommendResult[index]);
                        voiceComment += ", update " + lastRecommendType + " to " + lastRecommendResult[index];
                        lastRecommendFlag = 0;

                        return true;
                    } else {
                        voiceComment += "illegal selection";
                        return false;
                    }
                } else {
                    voiceComment += "illegal selection";
                    return false;
                }
            } else {
                voiceComment += "no recommend result could be selected";
                return false;
            }
        } else {
            // single field
            let field = this.extractField(statement);
            if (field.fieldName != '' && field.fieldValue != '') {
                this.fieldsMap.set(field.fieldName, field);

                update_comment(statement, "search " + field.fieldValue);
                voiceComment += ", search " + field.fieldValue;
            } else {

                update_comment(statement, "please give me a legal statement");
                voiceComment = "please give me a legal statement";

                return false;
            }
            // alert(field.fieldName + " " + field.fieldType + " " + field.fieldValue);
        }
        return true;
    } else {

        update_comment(statement, "please say aloha first");
        voiceComment = "please say aloha first";

        return false;
    }

};

Spl.prototype.isBinaryFieldStatement = function(statement) {

    let orString = this.getStringWithSamePattern(statement, "or", "double-metaphone");
    let andString = this.getStringWithSamePattern(statement, "and", "double-metaphone");

    if (statement.includes(orString)) {
        return true;
    }
    if (statement.includes(andString)) {
        return true;
    }
    return false;

};

Spl.prototype.isBetweenStatement = function(statement) {

    let betweenString = this.getStringWithSamePattern(statement, "between", "double-metaphone");
    let andString = this.getStringWithSamePattern(statement, "and", "double-metaphone");

    let index1 = statement.indexOf(betweenString);
    let index2 = statement.indexOf(andString);

    if (index1 >= 0 && index2 >= 0 && index1 < index2) {
        return true;
    } else {
        return false;
    }

};


function Field(fieldName, fieldValue, fieldType) {
    this.fieldName = fieldName;
    this.fieldValue = fieldValue;
    this.fieldType = fieldType;
}

function BinaryField(fieldName , fieldType, leftField, rightField) {
    this.fieldsName = fieldName;
    this.fieldType = fieldType;
    this.leftField = leftField;
    this.rightField = rightField;
}


function getRank(keyword, keywordList){
    for (let i = 0;i < keywordList.length;i ++) {
        if (keywordList[i] == keyword) {
            return i;
        }
    }
    // default rank is the lowest one
    return keywordList.length;
}

function getStatements(statement) {
    /**
     * get statements from statement
     */
    let skippedWords = ['could', 'can', 'would', 'please',
        'help', 'me', 'you' , 'should',
        'be', 'might', 'supposed', 'to', 'how', 'would', 'use'];

    let keyWords = ["where", "index", "type", "commit", "search", "rollback", "select", "aloha"];

    let words = statement.trim().split(/\s+/);
    words = words.filter(word => !(wordListMatch(word, skippedWords, "double-metaphone")));

    // find first keyword
    let i = 0;
    while (i < words.length) {
        if (wordListMatch(words[i], keyWords, "double-metaphone")) {
            break;
        }
        i ++;
    }

    let statements = [];
    while (i < words.length) {
        let nextStatement = words[i];
        // start rank
        let startRank = getRank(words[i], keyWords);
        i ++;
        while (i < words.length && (!wordListMatch(words[i], keyWords, "double-metaphone") || startRank <= getRank(words[i], keyWords))) {
            nextStatement = nextStatement + " " + words[i];
            i ++;
        }
        statements.push(nextStatement);
    }

    alert(statements.length + " statements");
    for (let s of statements) {
        alert(s);
    }

    return statements;
}

/**
 * the comment need to speak
 */
var voiceComment = '';

/*
    chrome initialize
 */
audio_recorder.onclick = function() {
    if(!started) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = function () {
            started = true;
            //document.getElementById("status").innerHTML = "start";
            SW.start();
            // set_aloha_status(true);
        };

        recognition.onerror = function (event) {
            // alert(event.error)
            started = false;
            SW.stop();
            set_aloha_status(false);
            //started = true;
            //document.getElementById("status").innerHTML = "start";
            //recognition.start();

            recognition.start();
            started = true;
        };

        recognition.onend = function () {
            //document.getElementById("status").innerHTML = "end";
            started = false;
            SW.stop();
            set_aloha_status(false);
            //started = true;
            //document.getElementById("status").innerHTML = "start";
            //recognition.start();

            // need to speak something
            if (voiceComment != '') {
                voice_comment(voiceComment);
                voiceComment = "";
            }

            /**
                trick here
             */
            setTimeout(function() {
                recognition.start();
                started = true;
            }, 500);
        };

        recognition.onresult = function (event) {
            let final_transcript = '';

            SW.stop();
            set_aloha_status(false);
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                final_transcript += event.results[i][0].transcript;
            }
            final_transcript = final_transcript.trim().toLowerCase();

            // for test here
            // final_transcript = testArray[testIndex];
            // alert("final_transcript " + final_transcript);
            // testIndex ++;

            if (!bshow){
                show_comment_div();
                bshow = false;
            }
            // update_comment(final_transcript, "just dummy comment...");
            // voice_comment("just dummy comment");

            alert(final_transcript);

            // TODO navigate
            // navigate_to(final_transcript);

            if (workMode == "") {
                if (final_transcript.trim().startsWith("aloha")) {
                    workMode = "search";
                    searchInitialize();

                    update_comment(final_transcript, "yes i'm here");
                    voiceComment = "yes i'm here";
                    // alert("start search");
                } else if (final_transcript.trim().startsWith("navigation")) {
                    workMode = "navigation";

                    update_comment(final_transcript, "start navigation");
                    voiceComment = "start navigation";
                    //alert("start navigation");
                }
            } else {
                if (workMode == "search") {
                    if (final_transcript.trim().startsWith("stop search")) {
                        workMode = "";
                        // alert("end search");

                        update_comment(final_transcript, "stop search");
                        voiceComment = "stop search";
                    } else {
                        // split statement
                        let statements = getStatements(final_transcript.trim());
                        // execute all statements
                        for (let statement of statements) {
                            let addResult = splManager.addNewStatement(statement);
                            if (addResult) {
                                let spl = splManager.toUrlString();
                                // spl is legal
                                if (spl != '') {
                                    let newURL = "http://localhost:8000/en-US/app/search/search?earliest=0&latest=&q=search%20" +
                                        encodeURI(spl) +
                                        "&display.page.search.mode=smart&dispatch.sample_ratio=1";

                                    chrome.tabs.query({active: true, currentWindow: true}, function (tabs) {
                                        var tab = tabs[0];
                                        chrome.tabs.update(tab.id, {url: newURL});
                                    });
                                    // chrome.tabs.create({ url: newURL });
                                } else {
                                    update_comment(final_transcript, "could not get spl from what you have said");
                                    voiceComment = "could not get spl from what you have said";
                                }
                            } else {
                                // alert("do not send spl request");
                                // update_comment(final_transcript, "do not update splunk search page");
                                // voiceComment = "do not send spl request";
                            }
                        }
                        // not simple aloha
                        if (!(statements.length == 1 && splManager.getStatementType(statements[0], false) == 'aloha')) {

                            splManager.setStatementFlag(false);
                        }
                        lastRecommendFlag = Math.max(lastRecommendFlag - 1 , 0);
                    }
                } else if (workMode == "navigation") {
                    if (final_transcript.trim().startsWith("end navigation")) {
                        workMode = "";
                    } else {
                        // TODO add navigation

                        alert("end navigation");
                    }
                }
            }
        };
        recognition.start();
    }
    else
    {
        recognition.stop();
    }
};

highlight_check_box.onclick  = function() {

    chrome.storage.sync.set({convert_color: !b_highlight}, function() {
        let icon_highlight = $('#convert_color');
        if (icon_highlight.hasClass('off')) {
            icon_highlight.removeClass('off');
            icon_highlight.addClass('on');
        }
        else
        {
            icon_highlight.addClass('off');
            icon_highlight.removeClass('on')
        }
        b_highlight = !b_highlight;
    });


    chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
        var tab = tabs[0];
        chrome.tabs.executeScript(tab.id, {
            code : 'render()'
        }, function() {});
    });
};

$(function() {
    chrome.storage.sync.get('convert_color', function (obj) {
        let icon_highlight = $('#convert_color');
        if(obj.convert_color){
            icon_highlight.removeClass('off');
            icon_highlight.addClass('on');
        }
        b_highlight = obj.convert_color;
    });

    SW = new SiriWave({
        width: 40,
        height: 15,
        speed: 0.05,
        amplitude: 1,
        //style: "ios9",
        container: document.getElementById('siric'),
        autostart: false,
        color: "#000"
    });
});


let testIndex = 0;
let testArray = [
                 // "let's have fun",
                 // "aloha index is internet",
                 // "aloha select apple"
    // "aloha","index is internet",
    // "aloha","type is splunkd",
    // "aloha","commit",
    // "aloha","where group equals to queue",
    // "aloha","where group equals to test",
    // "aloha","where group equals to queue",
    // "aloha","where current_size greater than 0",
    // "aloha","where current_size equals to 0",
    // "aloha","commit",
    // "aloha","where name equals to typingqueue and max_size_kb equals to 500",
    // "aloha", "commit",
    // "aloha","where largest_size between 10 and 20",
    // "aloha","where largest_size greater than 5 and largest_size less than 10",
    // "aloha","commit",
    // "aloha", "search info",
    // "aloha","commit",
    // "aloha","search test" , "aloha","rollback" , "aloha","rollback" , "aloha",'rollback' , '"aloha", rollback', 'end search'

];